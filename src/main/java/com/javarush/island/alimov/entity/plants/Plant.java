package com.javarush.island.alimov.entity.plants;
// –ü–∞–∫–µ—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–ª–∞—Å—Å Plant.

import com.javarush.island.alimov.Cell;
// –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ Cell ‚Äî –∫–ª–µ—Ç–∫–∞ –æ—Å—Ç—Ä–æ–≤–∞.

import com.javarush.island.alimov.Configuration;
// –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º—É–ª—è—Ü–∏–∏).

import com.javarush.island.alimov.Island;
// –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ Island ‚Äî –≤–µ—Å—å –æ—Å—Ç—Ä–æ–≤.

import java.util.List;
// –ò–º–ø–æ—Ä—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ List –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ø–∏—Å–∫–∞–º–∏.

import java.util.concurrent.ThreadLocalRandom;
// –ò–º–ø–æ—Ä—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥—ã.

import java.util.concurrent.locks.ReentrantLock;
// –ò–º–ø–æ—Ä—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤.
/**
 * –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å {@code Plant} –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ.
 * –†–∞—Å—Ç–µ–Ω–∏—è –æ–±–ª–∞–¥–∞—é—Ç –≤–µ—Å–æ–º, –≤–æ–∑—Ä–∞—Å—Ç–æ–º, –º–æ–≥—É—Ç —Ä–∞–∑–º–Ω–æ–∂–∞—Ç—å—Å—è –∏ —É–º–∏—Ä–∞—Ç—å.
 * –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å {@link Runnable}, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å
 * –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
 *
 * <p>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * <ul>
 *     <li>–•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏ (–∏–º—è, –∏–∫–æ–Ω–∫–∞, –≤–µ—Å, –∫–ª–µ—Ç–∫–∞).</li>
 *     <li>–†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–µ–π –∏–ª–∏ —Å–æ—Å–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–µ.</li>
 *     <li>–£—á–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∂–∏–≤–æ–µ/–º–µ—Ä—Ç–≤–æ–µ).</li>
 *     <li>–£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏.</li>
 * </ul>
 *
 * –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
 * <pre>{@code
 * Plant grass = new Grass("Grass", "üåø", 1.0, 200, cell, island, true);
 * grass.run(); // –∑–∞–ø—É—Å–∫–∞–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ä–∞—Å—Ç–µ–Ω–∏—è
 * }</pre>
 */
public abstract class Plant implements Runnable {
    // –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å Plant, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Ä–∞—Å—Ç–µ–Ω–∏–µ. –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Runnable –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏.

    protected final String name;
    // –ò–º—è —Ä–∞—Å—Ç–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Grass").

    protected final String icon;
    // –ò–∫–æ–Ω–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è (—ç–º–æ–¥–∑–∏ –∏–ª–∏ —Å–∏–º–≤–æ–ª).

    protected volatile double currentWeight;
    // –¢–µ–∫—É—â–∏–π –≤–µ—Å —Ä–∞—Å—Ç–µ–Ω–∏—è. volatile ‚Äî –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ.

    protected final int maxPerCell;
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ –≤ –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–µ.

    protected volatile Cell currentCell;
    // –ö–ª–µ—Ç–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–∞—Å—Ç–µ–Ω–∏–µ.

    protected final Island island;
    // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Å—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ.

    protected volatile boolean isAlive;
    // –§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è (–∂–∏–≤–æ–µ/–º–µ—Ä—Ç–≤–æ–µ).

    protected int age = 0;
    // –í–æ–∑—Ä–∞—Å—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ç–∏–∫).

    protected final ReentrantLock lock = new ReentrantLock();
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—ä–µ–∫—Ç—É —Ä–∞—Å—Ç–µ–Ω–∏—è.
    /**
     * –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è.
     *
     * @param name –∏–º—è —Ä–∞—Å—Ç–µ–Ω–∏—è
     * @param icon –∏–∫–æ–Ω–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è
     * @param currentWeight —Ç–µ–∫—É—â–∏–π –≤–µ—Å
     * @param maxPerCell –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–µ–Ω–∏–π –≤ –∫–ª–µ—Ç–∫–µ
     * @param currentCell –∫–ª–µ—Ç–∫–∞, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–∞—Å—Ç–µ–Ω–∏–µ
     * @param island –æ—Å—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ
     * @param isAlive —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è (–∂–∏–≤–æ–µ/–º–µ—Ä—Ç–≤–æ–µ)
     */
    public Plant(String name, String icon, double currentWeight, int maxPerCell,
                 Cell currentCell, Island island, boolean isAlive) {
        // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ª—è.
        this.name = name;
        this.icon = icon;
        this.currentWeight = currentWeight;
        this.maxPerCell = maxPerCell;
        this.currentCell = currentCell;
        this.island = island;
        this.isAlive = isAlive;
    }

    public void setCurrentWeight(double currentWeight) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤–µ—Å —Ä–∞—Å—Ç–µ–Ω–∏—è.
        this.currentWeight = currentWeight;
    }

    public void setAlive(boolean alive) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è (–∂–∏–≤–æ–µ/–º–µ—Ä—Ç–≤–æ–µ).
        isAlive = alive;
    }

    // –ì–µ—Ç—Ç–µ—Ä—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª—è–º:
    public String getName() { return name; }
    public String getIcon() { return icon; }
    public double getCurrentWeight() { return currentWeight; }
    public int getMaxPerCell() { return maxPerCell; }
    public Cell getCurrentCell() { return currentCell; }
    public Island getIsland() { return island; }
    public boolean isAlive() { return isAlive; }
    /**
     * –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è.
     * –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, Grass).
     *
     * @param cell –∫–ª–µ—Ç–∫–∞, –≥–¥–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
     * @param island –æ—Å—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ
     * @return –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è
     */
    protected abstract Plant createNewInstance(Cell cell, Island island);
    // –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö).

    /**
     * –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–π –∏–ª–∏ —Å–æ—Å–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–µ.
     *
     * @param cell –∫–ª–µ—Ç–∫–∞, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–∞—Å—Ç–µ–Ω–∏–µ
     * @param island –æ—Å—Ç—Ä–æ–≤
     */
    public void reproduce(Cell cell, Island island) {
        // –ú–µ—Ç–æ–¥ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è.
        lock.lock();
        // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
        try {
            int rnd = ThreadLocalRandom.current()
                    .nextInt(Configuration.MAX_PLANTS_REPRODUCE_IN_1_TICK);
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è.

            if (!cell.hasSpaceForPlant(this)) return;
            // –ï—Å–ª–∏ –≤ –∫–ª–µ—Ç–∫–µ –Ω–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏—è ‚Äî –≤—ã—Ö–æ–¥–∏–º.

            for (int i = 0; i <= rnd; i++) {
                // –¶–∏–∫–ª —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è.
                if (this.age >= 2) return;
                // –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ (–≤–æ–∑—Ä–∞—Å—Ç >= 2), –æ–Ω–æ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–∑–º–Ω–æ–∂–∞–µ—Ç—Å—è.

                if (ThreadLocalRandom.current().nextDouble() < Configuration.NEIGHBOR_CELL_REPRODUCE_CHANCE) {
                    // –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º: —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –≤ —Å–æ—Å–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–µ.
                    Cell neighbor = getRandomNeighborCell(cell, island);
                    if (neighbor != null && neighbor.hasSpaceForPlant(this)) {
                        neighbor.addPlant(createNewInstance(neighbor, island));
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ —Å–æ—Å–µ–¥–Ω—é—é –∫–ª–µ—Ç–∫—É.
                    }
                } else {
                    cell.addPlant(createNewInstance(cell, island));
                    // –ò–Ω–∞—á–µ ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–µ–π –∫–ª–µ—Ç–∫–µ.
                }
            }
        } finally {
            lock.unlock();
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
        }
    }
    /**
     * –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ä–∞—Å—Ç–µ–Ω–∏—è.
     * <p>–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç, –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–º–Ω–æ–∂–∏—Ç—å—Å—è,
     * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è —Å–º–µ—Ä—Ç–∏ (–≤–µ—Å ‚â§ 0 –∏–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç ‚â• MAX_AGE_PLANTS).</p>
     */
    @Override
    public void run() {
        // –ú–µ—Ç–æ–¥ run ‚Äî –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ä–∞—Å—Ç–µ–Ω–∏—è, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
        lock.lock();
        this.age++;
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è.
        try {
            if (!isAlive) return;
            // –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –º—ë—Ä—Ç–≤–æ–µ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º.

            reproduce(currentCell, island);
            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–º–Ω–æ–∂–∏—Ç—å—Å—è.

            if (this.currentWeight <= 0 || this.age >= Configuration.MAX_AGE_PLANTS) {
                // –ï—Å–ª–∏ –≤–µ—Å <= 0 –∏–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç –ø—Ä–µ–≤—ã—Å–∏–ª –º–∞–∫—Å–∏–º—É–º ‚Äî —Ä–∞—Å—Ç–µ–Ω–∏–µ —É–º–∏—Ä–∞–µ—Ç.
                isAlive = false;
                currentCell.removePlant(this);
                // –£–¥–∞–ª—è–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–µ –∏–∑ –∫–ª–µ—Ç–∫–∏.
            }
        } finally {
            lock.unlock();
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
        }
    }
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å–æ—Å–µ–¥–Ω—é—é –∫–ª–µ—Ç–∫—É.
     *
     * @param cell —Ç–µ–∫—É—â–∞—è –∫–ª–µ—Ç–∫–∞
     * @param island –æ—Å—Ç—Ä–æ–≤
     * @return —Å–ª—É—á–∞–π–Ω–∞—è —Å–æ—Å–µ–¥–Ω—è—è –∫–ª–µ—Ç–∫–∞ –∏–ª–∏ {@code null}, –µ—Å–ª–∏ —Å–æ—Å–µ–¥–µ–π –Ω–µ—Ç
     */
    private Cell getRandomNeighborCell(Cell cell, Island island) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å–æ—Å–µ–¥–Ω—é—é –∫–ª–µ—Ç–∫—É.
        List<Cell> neighbors = island.getNeighbors(cell.getX(), cell.getY());
        if (neighbors == null || neighbors.isEmpty()) {
            return null;
        }
        return neighbors.get(ThreadLocalRandom.current().nextInt(neighbors.size()));
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ—Å–µ–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞.
    }
}


